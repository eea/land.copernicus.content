<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<body>
<metal:title fill-slot="content-title">
 <h1 metal:use-macro="context/kss_generic_macros/macros/generic_title_view"></h1>
 <div class='not-validated-container'>
   <span class='not-validated-tag'>
      <span tal:define="not_validated_custom python: context.getField('notValidatedCustomText').getAccessor(context)()"
            tal:replace="structure not_validated_custom">
   </span>
 </div>
</metal:title>

<metal:description fill-slot="content-description" />

<metal:content-core fill-slot="content-core">
  <metal:main_macro define-macro="content-core">
    <script>
      function show_iframe() {
        jQuery(".loading_message").hide();
      }
    </script>
    <style>
      @import url("https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css");
      @import url("https://cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css");
      @import url("./eea-tooltips.css");
      @import url("./landitem_view.css");
    </style>

    <dl class="enableFormTabbing"
        tal:define="membership python:context.portal_membership;
                    member python:user if not membership.isAnonymousUser() else None;
                    user_is_admin python:checkPermission('Manage portal', here);
                    member_profile python:member and member.getProperty('institutional_domain', False) and member.getProperty('thematic_domain', False);
                    context_download python:getattr(context, 'show_new_download', None);
                    show_download python:context_download or user_is_admin;
                    can_download python:member and member_profile">

      <!-- Map View -->
      <tal:mapview define="html context/embed_iframe">
        <dt id="fieldsetlegend-mapview" i18n:translate="">Map View</dt>
        <dd id="fieldset-mapview" style="margin: 0px; padding-top: 0px !important">
          <div class="mapview-field" style="border: 1px solid #BFD630; border-top: 0px;">
            <div class="loading_message" tal:condition="context/has_iframe">
              <div id="squaresWaveG">
                <div id="squaresWaveG_1" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_2" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_3" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_4" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_5" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_6" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_7" class="squaresWaveG">
                </div>
                <div id="squaresWaveG_8" class="squaresWaveG">
                </div>
              </div>
              <center>Please wait, loading map...</center>
            </div>
            <tal:service replace="structure html" />
          </div>
        </dd>
      </tal:mapview>

      <!-- Metadata -->
      <tal:metadata define="field python:context.getField('text') if getattr(context, 'getField', None) else None;
                            html python:field.getAccessor(context)() if field else ''">
        <dt id="fieldsetlegend-metadata" i18n:translate="">Metadata</dt>
        <dd id="fieldset-metadata">
          <div class="metadata-field">
            <tal:service replace="structure html" />
            <tal:service replace="structure context/@@product-inline-view" />
          </div>
        </dd>
      </tal:metadata>

      <!-- New Download -->
      <tal:download tal:condition="show_download"
                    tal:define="portal_url python:context.portal_url()">
        <dt id="fieldsetlegend-download" i18n:translate="">Download</dt>
        <dd id="fieldset-download"
            tal:define="download_info python: context.getField('download').getAccessor(context)()">

          <div tal:condition="python:download_info" id="download-info">
            <span tal:replace="structure download_info"></span>
          </div>

          <div id="datatable-container">
            <table id="data-table-download" width="100%"
                   tal:define="catfields python:context.getField('fileCategories').getAccessor(context)()">
              <thead>
                <tr role="row">
                  <tal:download condition="can_download">
                    <th class="border-bottom-only no-sort">
                    </th>
                  </tal:download>
                  <th class="border-bottom-only special-chars-sort">Name</th>
                  <th class="border-bottom-only" tal:repeat="cat catfields">
                    <span tal:replace="cat">Type</span>
                  </th>
                  <th class="border-bottom-only file-size-column">Size</th>
                  <tal:download condition="can_download">
                    <th class="border-bottom-only text-centered no-sort">Download</th>
                  </tal:download>
                  <th class="border-bottom-only search-tags-hidden-column">Search tags</th>
                </tr>
              </thead>

              <tbody >
                <tal:landfile repeat="item_brain python: context.getFolderContents(contentFilter={'portal_type' : 'LandFile', 'review_state': 'published'})">
                  <tr>
                    <tal:def tal:define="item python:item_brain.getObject();
                                         fileCategories python: item.getField('fileCategories').getAccessor(item)() or [{}];
                                         fileCategories python: {d.get('name', ''): d.get('value', '') for d in fileCategories};">
                      <tal:download condition="can_download">
                        <td class="border-top-only" data-role="checkbox">
                          <input class="checkbox-select-item" type="checkbox" name="selected:list" tal:attributes="value python:item.getId()" />
                        </td>
                      </tal:download>

                      <td class="border-top-only" tal:content="item/Title"></td>

                      <tal:repeat repeat="catName catfields">
                        <td tal:define="value python:fileCategories.get(catName, '')" class="border-top-only">
                          <span tal:content="python:value"
                                tal:attributes="class python:value.lower().replace(' ', '-')">Value</span>
                        </td>
                      </tal:repeat>
                      <td class="border-top-only" tal:content="item/getFileSize">70.14 MB</td>
                      <tal:download condition="can_download">
                        <td class="border-top-only text-centered no-sorting-icons" data-role="download">
                          <a href="#" tal:attributes="data-href string:${item/absolute_url}/download-land-file" class="download-button disabled">
                             <i class="fa fa-download"></i>
                          </a>
                        </td>
                      </tal:download>
                      <td tal:content="python:item.Description()"></td>
                    </tal:def>
                  </tr>
                </tal:landfile>
              </tbody>
            </table>
          </div>

          <hr />

          <tal:download condition="can_download">
          <div tal:define="isValidateDataset python:context.getField('isValidatedDataset').getAccessor(context)()">
            <form id="download-form" action="." method="POST">
              <p>
                You selected <strong><span data-role="number-checked">0</span> files</strong> for download. The limit
                is <strong><span data-role="download-limit">5</span> files</strong>. Please fill in your email to send you the download link.
              </p>
              <label>Email
                <input type="email" name="email" tal:attributes="value python:member.getProperty('email', '')" required />
              </label>
              <button id="button-download-selected" class="btn btn-default">Send</button>
              <tal:condition condition="python:isValidateDataset is not True">
                <hr />
                <div id="text-accept-non-validated">
                  <input id="checkbox-accept-non-validated" type="checkbox" name="accept-non-validated" value="yes" required />
                  <label for="checkbox-accept-non-validated">
                    I am aware that I am downloading non-validated data and I accept to not distribute the
                    information contained in these files or the files themselves any further.
                  </label>
                </div>
              </tal:condition>
            </form>
          </div>
          </tal:download>

          <script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
          <script type="text/javascript" language="javascript" src="eea-tooltips.js"></script>
          <script type="text/javascript" language="javascript" src="landitem_view.js"></script>
        </dd>
      </tal:download>
      <tal:no-profile condition="python:member and not member_profile">
        <p>Please <a tal:attributes="href string:${portal_url}/@@personal-information">complete your profile</a> in order to download data.</p>
      </tal:no-profile>
      <tal:anon condition="python:not member">
        <p>Please <a href="./login">login</a> in order to download data.</p>
      </tal:anon>

    </dl>
  </metal:main_macro>
</metal:content-core>
</body>
</html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<body>

<metal:description fill-slot="content-description" />

<metal:content-core fill-slot="content-core">
<metal:main_macro define-macro="content-core">
  <script>
    function show_iframe(){
      jQuery(".loading_message").hide();
    }
  </script>
  <style>
  @import url("http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css");
  @import url("http://cdn.datatables.net/1.10.6/css/jquery.dataTables.min.css");
  @import url("./eea-tooltips.css");

  .loading_message {
    height:450px; 
    width:900px;
    line-height:450px;
    position:absolute;
  }
  #squaresWaveG{
    position:absolute;
    top:250px;
    left:330px;
    width:240px;
    height:29px;
  z-index:1000;}

  .squaresWaveG{
    position:absolute;
    top:0;
    background-color:#C0D630;
    width:29px;
    height:29px;
    -moz-animation-name:bounce_squaresWaveG;
    -moz-animation-duration:1.3s;
    -moz-animation-iteration-count:infinite;
    -moz-animation-direction:linear;
    -webkit-animation-name:bounce_squaresWaveG;
    -webkit-animation-duration:1.3s;
    -webkit-animation-iteration-count:infinite;
    -webkit-animation-direction:linear;
    -ms-animation-name:bounce_squaresWaveG;
    -ms-animation-duration:1.3s;
    -ms-animation-iteration-count:infinite;
    -ms-animation-direction:linear;
    -o-animation-name:bounce_squaresWaveG;
    -o-animation-duration:1.3s;
    -o-animation-iteration-count:infinite;
    -o-animation-direction:linear;
    animation-name:bounce_squaresWaveG;
    animation-duration:1.3s;
    animation-iteration-count:infinite;
    animation-direction:linear;
  }

  #squaresWaveG_1{
    left:0;
    -moz-animation-delay:0.52s;
    -webkit-animation-delay:0.52s;
    -ms-animation-delay:0.52s;
    -o-animation-delay:0.52s;
    animation-delay:0.52s;
  }

  #squaresWaveG_2{
    left:30px;
    -moz-animation-delay:0.65s;
    -webkit-animation-delay:0.65s;
    -ms-animation-delay:0.65s;
    -o-animation-delay:0.65s;
    animation-delay:0.65s;
  }

  #squaresWaveG_3{
    left:60px;
    -moz-animation-delay:0.78s;
    -webkit-animation-delay:0.78s;
    -ms-animation-delay:0.78s;
    -o-animation-delay:0.78s;
    animation-delay:0.78s;
  }

  #squaresWaveG_4{
    left:90px;
    -moz-animation-delay:0.91s;
    -webkit-animation-delay:0.91s;
    -ms-animation-delay:0.91s;
    -o-animation-delay:0.91s;
    animation-delay:0.91s;
  }

  #squaresWaveG_5{
    left:120px;
    -moz-animation-delay:1.04s;
    -webkit-animation-delay:1.04s;
    -ms-animation-delay:1.04s;
    -o-animation-delay:1.04s;
    animation-delay:1.04s;
  }

  #squaresWaveG_6{
    left:150px;
    -moz-animation-delay:1.17s;
    -webkit-animation-delay:1.17s;
    -ms-animation-delay:1.17s;
    -o-animation-delay:1.17s;
    animation-delay:1.17s;
  }

  #squaresWaveG_7{
    left:180px;
    -moz-animation-delay:1.3s;
    -webkit-animation-delay:1.3s;
    -ms-animation-delay:1.3s;
    -o-animation-delay:1.3s;
    animation-delay:1.3s;
  }

  #squaresWaveG_8{
    left:210px;
    -moz-animation-delay:1.43s;
    -webkit-animation-delay:1.43s;
    -ms-animation-delay:1.43s;
    -o-animation-delay:1.43s;
    animation-delay:1.43s;
  }

  @-moz-keyframes bounce_squaresWaveG{
    0%{
      background-color:#C0D630;
    }
    100%{
      background-color:#FFFFFF;
    }
  }

  @-webkit-keyframes bounce_squaresWaveG{
    0%{
      background-color:#C0D630;
    }
    100%{
      background-color:#FFFFFF;
    }
  }

  @-ms-keyframes bounce_squaresWaveG{
    0%{
      background-color:#C0D630;
    }
    100%{
      background-color:#FFFFFF;
    }
  }

  @-o-keyframes bounce_squaresWaveG{
    0%{
      background-color:#C0D630;
    }
    100%{
      background-color:#FFFFFF;
    }
  }

  @keyframes bounce_squaresWaveG{
    0%{
      background-color:#C0D630;
    }
    100%{
      background-color:#FFFFFF;
    }
  }


  /* Download tab: datatable styles */
  #datatable-container{
    margin-top:-26px;
  }

  #datatable-container table.dataTable thead .sorting_asc {
    background: url("http://cdn.datatables.net/1.10.0/images/sort_asc.png") no-repeat center left !important; /* Fix move sort icon to left */
  }

  #datatable-container table.dataTable thead .sorting_desc {
    background: url("http://cdn.datatables.net/1.10.0/images/sort_desc.png") no-repeat center left !important; /* Fix move sort icon to left */
  }

  #datatable-container table.dataTable thead .sorting {
    background: url("http://cdn.datatables.net/1.10.0/images/sort_both.png") no-repeat center left !important; /* Fix move sort icon to left */
  }

  #data-table-download{
    border-collapse:collapse;
    background-color:white;
    table-layout:fixed;
    width:200px;
    margin-bottom: 0px !important;
  }

  #data-table-download thead>tr>th{
    padding-left: 16px !important;
  }

  #data-table-download td, th{
    padding:15px !important;
    overflow:hidden;
    width:100px;
  }

  #data-table-download .border-bottom-only{
    border-left:none;
    border-right:none;
    border-top:none;
    border-bottom:1px solid black;
  }

  #data-table-download .border-top-only{
    border-left:none;
    border-right:none;
    border-bottom:none;
    border-top:1px solid #CCC;
  }

  #data-table-download tbody>tr:hover{
    background-color:#DFF2FF;
  }

  span.vector, span.raster{
    display:inline;
    padding:.3em .6em .3em;
    font-size:80%;
    font-weight:bold;
    line-height:1;
    color:#fff;
    text-align:center;
    white-space:nowrap;
    vertical-align:baseline;
    border-radius:.25em;
  }

  span.vector{
    background-color:#FDA42C !important;
    text-shadow: 0px 1px 1px #8A591A;
  }

  span.raster{
    background-color:#D21359 !important;
    text-shadow: 0px 1px 1px #6E0B2F;
  }

  .download-button{
    margin-top:-3px;
    margin-bottom:-3px;
    background-color:#0A70B2;
    color:white !important;
    text-decoration:none !important;
    padding-top:5px;
    padding-bottom:5px;
    padding-left:5px;
    padding-right:5px;
    border:none;
  }

  .download-button:hover{
    color:#fff !important; /* [TODO] Fix color problem here */
  }

  #data-table-download_info{
    padding-top:3px;
    padding-left:15px;
    float:left;
  }

  #data-table-download_length{
    float:left;
    padding-left:15px;
    padding-top:15px;
    padding-bottom:15px;
  }

  #data-table-download_filter{
    float:right;
    padding-top:15px;
    padding-right:15px;
  }

  #data-table-download_paginate{
    padding-top:3px;
    padding-right:15px;
    padding-bottom:15px;
    float:right;
  }


  /* Metadata tab styles */
  #detailed-metadata-title, #access-and-use-title{
    padding-top: 25px;
  }

  .detailed-metadata-container{
    margin-top: 15px;
    border:1px solid #CCC;
    padding-top:15px;
    padding-left:15px;
    padding-right:15px;
    padding-bottom:0px;
    overflow: hidden;
  }

  .detailed-metadata-container dl{
    float:left;
    width:100%;
    margin-bottom:0px !important;
  }

  .detailed-metadata-container dt{
    float:left;
    width:24%;
    text-align:right;
  }

  .detailed-metadata-container dd{
    float:left;
    width:72%;
    padding-top:0px !important;
    padding-left:15px;
  }

  .detailed-metadata-container dd p{
    margin-bottom:0.5em !important;
  }

  #temporal_dynamic {
    display:none;
  }

  .label-tag{
    display:inline;
    padding:.2em .6em .3em;
    font-size:75%;
    font-weight:bold;
    line-height:1;
    text-align:center;
    text-decoration:none !important;
    white-space:nowrap;
    vertical-align:baseline;
    border-radius:.25em;
    background-color:#989898 !important;
    color: white !important;
    margin-right:5px;
  }

  .label-tag:hover{
    background-color:#4D4D4D !important;
    color:white !important;
  }

  .label-white-color{
    color:white !important;
  }

  .label-white-color:hover{
    color:white !important;
  }

  #category{
    display:none; /* Fix Remove "Filed under" section */
  }

  .download-gray-icon{
    color:#CCC;
  }

  .text-centered{
    text-align:center;
  }

  #data-table-download_info{
    display:none;
  }

  #disclaimer-download-container{
    margin-top:15px;
    padding-left:25%;
    padding-right:25%;
  }

  #checkbox-accept-non-validated{
    float:left;
    width:7%;
    margin-top:3px;
  }

  #text-accept-non-validated{
    float:right;
    width:93%;
    margin-bottom:10px;
  }

  #button-download-selected, #button-download-all{
    background-color:#F2F2F2;
    width:49%;
    padding-top:5px;
    padding-bottom:5px;
    border:1px solid #D8D8D8;
    font-weight:bold;
    color:#595959;
    border-radius:3px;
  }

  #button-download-selected:hover, #button-download-all:hover{
    background-color:#0870AF;
    border:1px solid #0063A8;
    color:#fff;
  }

  #button-download-selected:disabled, #button-download-all:disabled{
    background-color:#F2F2F2;
    border-color:#D8D8D8;
    color:#BBB !important;
  }

  .download-button.disabled{
    background-color:#BBB;
  }

  #button-download-selected{
    float:left;
  }

  #button-download-all{
    float:right;
  }

  .not-validated-tag{
    position:relative;
    bottom:2px;
    display:inline;
    background-color:#323232;
    color:white;
    padding-left:7px;
    padding-right:7px;
    padding-top:1px;
    padding-bottom:1px;
    border-radius:3px;
  }

  .download-button i{
    color: white !important;
  }
</style>

<dl class="enableFormTabbing">

  <!-- Map View -->
  <tal:mapview define="html context/embed_iframe">
    <dt id="fieldsetlegend-mapview" i18n:translate="">Map View</dt>
    <dd id="fieldset-mapview" style="margin:0px; padding-top:0px !important">
      <div class="mapview-field" style="border:1px solid #BFD630; border-top:0px;">
        <div class="loading_message" tal:condition="context/has_iframe">
          <div id="squaresWaveG">
            <div id="squaresWaveG_1" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_2" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_3" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_4" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_5" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_6" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_7" class="squaresWaveG">
            </div>
            <div id="squaresWaveG_8" class="squaresWaveG">
            </div>
          </div>
          <center>Please wait, loading map...</center>
        </div>
        <tal:service replace="structure html" />
      </div>
    </dd>
  </tal:mapview>

  <!-- Metadata -->
  <tal:metadata define="
    field python:context.getField('text') if getattr(context, 'getField', None) else None;
    html python:field.getAccessor(context)() if field else ''" tal:condition="html">
    <dt id="fieldsetlegend-metadata" i18n:translate="">Metadata</dt>
    <dd id="fieldset-metadata">
      <div class="metadata-field">
        <tal:service replace="structure html" />
        <tal:service replace="structure context/@@product-inline-view" />
      </div>
    </dd>
  </tal:metadata>

  <!-- Download -->
  <tal:download tal:condition="python:getattr(context, 'show_new_download', None) is True">
    <dt id="fieldsetlegend-download" i18n:translate="">New Download</dt>
    <dd id="fieldset-download">
      <div id="datatable-container">
        <table id="data-table-download" width="100%" tal:define="catfields python:context.getField('fileCategories').getAccessor(context)()">
          <thead>
            <tr role="row">
              <th class="border-bottom-only no-sort">
                <input class="checkbox-select-all" type="checkbox" value="select-item" />
              </th>
              <th class="border-bottom-only">Name</th>
              <th class="border-bottom-only" tal:repeat="cat catfields">
                <span tal:replace="cat">Type</span>
              </th>
              <th class="border-bottom-only">Size</th>
              <th class="border-bottom-only text-centered no-sort">Download</th>
            </tr>
          </thead>

          <tbody >
            <tal:repeat repeat="item_brain python: context.getFolderContents(contentFilter={'portal_type' : 'LandFile'})">
              <tr tal:condition="python:item_brain.review_state == 'published'">
                <tal:def tal:define="item python:item_brain.getObject();
                    fileCategories python: item.getField('fileCategories').getAccessor(item)() or [{}];
                    fileCategories python: {d.get('name', ''): d.get('value', '') for d in fileCategories};
                    ">
                  <td class="border-top-only">
                    <input class="checkbox-select-item" type="checkbox" value="select-item" />
                  </td>

                  <td class="border-top-only" tal:content="item/Title"></td>

                  <tal:repeat repeat="catName catfields">
                    <td tal:define="value python:fileCategories.get(catName, '')" class="border-top-only">
                      <span tal:content="python:value"
                            tal:attributes="class python:value.lower().replace(' ', '-')">Value</span>
                    </td>
                  </tal:repeat>
                  <td class="border-top-only">
                    <span class="info-size" tal:content="item/getFileSize">70.14 MB</span>
                  </td>
                  <td class="border-top-only text-centered no-sorting-icons">
                    <span class="download-gray-icon"><i class="fa fa-download"></i></span>
                    <a tal:attributes="href python: item.absolute_url() + '/@@redirect-download-url'"
                       href="" class="download-button"><i class="fa fa-download"></i></a>
                  </td>
                </tal:def>
              </tr>
            </tal:repeat>
          </tbody>
        </table>
      </div>

      <div id="disclaimer-download-container"
        tal:define="isValidateDataset python:context.getField('isValidatedDataset').getAccessor(context)()">
        <form id="disclaimer-download-form" action="">
          <tal:condition condition="python:isValidateDataset is not True">
            <input id="checkbox-accept-non-validated" type="checkbox" name="accept-non-validated" value="accept-non-validated" />
            <span id="text-accept-non-validated">I am aware that I am downloading non-validated data and I accept to not distribute the information contained in these files or the files themselves any further.</span>
          </tal:condition>
          <button id="button-download-selected">Download selected items
            (<span id="number-checked">0</span>)
          </button>
          <button id="button-download-all">Download all</button>
        </form>
      </div>

      <script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js"></script>
      <script type="text/javascript" language="javascript" src="eea-tooltips.js"></script>

      <script>
        $(document).ready(function(){
          function is_validated_dataset(){
            return $("#checkbox-accept-non-validated").length === 0;
          }

          function add_not_validated_tag(){
            $("#parent-fieldname-title").css("display", "inline");
            $("#parent-fieldname-title").after("<span class='not-validated-tag'>Not validated.</span>");
          }
          function disable_download_buttons(){
            $("#button-download-selected").attr("disabled", "disabled");
            $("#button-download-all").attr("disabled", "disabled");
            $(".download-button").addClass("disabled");
          }

          function enable_download_buttons(){
            $("#button-download-selected").removeAttr("disabled");
            $("#button-download-all").removeAttr("disabled");
            $(".download-button").removeClass("disabled");
          }

          function get_number_checked_items(){
            var number_checked = $('.checkbox-select-item:checked').size();
            return number_checked;
          }

          function check_all_items(){
            $('.checkbox-select-item').attr('checked', true);
          }

          function uncheck_all_items(){
            $('.checkbox-select-item').attr('checked', false);
          }

          function refresh_counter(){
            $("#number-checked").text(get_number_checked_items());
          }

          function save_selected_items_in_url(){
            // For after login. Download tab is opened and these items will be checked automatically.
            var selected = "?selected=";
            $('.checkbox-select-item').each(function(i){
              if($(this).attr("checked")){
                selected += i + '-'
              }
            });

            $('.download-button').each(function(){
              var old_href = $(this).attr("href");
              $(this).attr("href", old_href + selected);
            });

          }

          function download_all(){
            save_selected_items_in_url();
            var download_buttons = $('.download-button');
            for(var i = 0; i < download_buttons.length; i++){
              var button = download_buttons[i];
              $(button).attr("target", "_blank");
              button.click();
              $(button).removeAttr("target");
            }
          }

          function download_selected(){
            save_selected_items_in_url();
            var download_buttons = $('.checkbox-select-item:checked')
                                   .closest('tr').find('.download-button');

            for(var i = 0; i < download_buttons.length; i++){
              var button = download_buttons[i];
              $(button).attr("target", "_blank");
              button.click();
              $(button).removeAttr("target");
            }
          }

          function auto_accept_not_validated(){
            $("#checkbox-accept-non-validated").attr("checked", true);
            enable_download_buttons();
          }

          function auto_select_checkboxes(checkboxes_indexes_array){
            $('.checkbox-select-item').each(function(i){
              if($.inArray(i.toString(), checkboxes_indexes_array) != -1){
                $(this).attr("checked", true);
              }
            });
          }

          function display_portal_message(message_text, message_type){
            $('<dl class="portalMessage ' + message_type + '"><dt>Error</dt><dd>' +
              message_text + '</dd></dl>').insertBefore('.documentFirstHeading');
          }

          function display_errors_if_any(download_tab_param){
          // Example: ?fieldsetlegend-download=true-error-not-found-LandFile3
          // -> "LandFile3 cannot be downloaded. Broken link."
            var error_missing_file = "true-error-not-found-";
            if (download_tab_param.indexOf(error_missing_file) >= 0) {
              var land_file_title = download_tab_param.substring(error_missing_file.length, download_tab_param.length);
              if (land_file_title.length == 0) {
                land_file_title = "This land file"
              }

              display_portal_message(decodeURI(land_file_title) + " cannot be downloaded. Link is broken.", "error");
            }
          }

          function download_auto_selected(download_tab_param){
          // Example in URL: fieldsetlegend-download=true-selected-0-1 => autoselected first 2 checkboxes
            var auto_selected_checkboxes_indexes = download_tab_param.split("-").filter(function(c){return !isNaN(c)&&(c != '');});
            auto_select_checkboxes(auto_selected_checkboxes_indexes);
            refresh_counter();
            auto_accept_not_validated();
            download_selected();
          }

          function interpret_url_params_if_any(){
          // Check parameter in url for after login case or error missing land file
          // Auto open download tab and download if any auto selected.

            function get_url_parameter(sParam){
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++){
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] == sParam){
                        return sParameterName[1];
                    }
                }
            }

            var download_tab_param = get_url_parameter('fieldsetlegend-download');
            if (download_tab_param != undefined){
              $("#fieldsetlegend-download").click();
              download_auto_selected(download_tab_param);
              display_errors_if_any(download_tab_param);
            }
          }

          // INIT
          if (!is_validated_dataset()){
            disable_download_buttons();
            add_not_validated_tag();
          } else {
            enable_download_buttons();
          }

          interpret_url_params_if_any();  // set by RedirectDownloadUrl class

          $('#data-table-download').dataTable({
            "order": [[ 1, "asc" ]],
            "columnDefs": [
              { "targets": 'no-sort', "orderable": false },
              { "width": "20px", "targets": 0 }
            ],
            paging: false
          });

          // tr hover
          $('.download-button').hide();
          $('#data-table-download > tbody > tr').on("mouseenter", function(){
            $(this).find('a.download-button').show();
            $(this).find('.download-gray-icon').hide();
          });

          $('#data-table-download > tbody > tr').on("mouseleave", function(){
            $(this).find('a.download-button').hide();
            $(this).find('.download-gray-icon').show();
          });

          // accept (un)checked
          $("#checkbox-accept-non-validated").change(function(){
            if(this.checked) {
              enable_download_buttons();
            } else {
              disable_download_buttons();
            }
          });

          // item (un)checked
          $(".checkbox-select-item").change(function(){
            refresh_counter();
          });

          // (un)select all items
          $(".checkbox-select-all").change(function(){
            if(this.checked) {
              check_all_items();
            } else {
              uncheck_all_items();
            }
            refresh_counter();
          });

          // DOWNLOAD
          $('#button-download-selected').on("click", function(evt){
            evt.preventDefault();
            download_selected();
          });

          $('#button-download-all').on("click", function(evt){
            evt.preventDefault();
            download_all();
          });

          $('.download-button').on("click", function(evt){
            if($(this).hasClass("disabled")){
              evt.preventDefault();
            }
          });
        });
      </script>
    </dd>
  </tal:download>

  <!-- Download Old - temporary download -->
  <tal:download>
    <dt id="fieldsetlegend-download-old" i18n:translate="">Download</dt>
    <dd id="fieldset-download-old"
        tal:define="download_info python: context.getField('download').getAccessor(context)()">
      <div tal:replace="structure download_info"></div>
    </dd>
  </tal:download>

</dl>

</metal:main_macro>

</metal:content-core>

</body>

</html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<body>
  <metal:description fill-slot="content-description" />

  <metal:content-core fill-slot="content-core">
    <metal:main_macro define-macro="content-core">

<style type="text/css">
  div[data-diazo=insitu-news-list],
  div[data-diazo=insitu-events-list] {
    display: none;
  }
  .insitu-btn-observations:hover,
  .insitu-btn-spatial-data:hover {
    text-decoration: none !important;
  }

  .btn.pressed {
    border: 2px solid #000000;
    border-bottom: 2px solid #000000 !important;
  }

  .insitu-btn-tags-container:not(.search-filters) {
    display: none;
  }
</style>

<div id="search-app" class="container"
     ng-app="searchApp" ng-controller="searchController as app">
  <div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

      <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>

      <h1>Search by tags</h1>
      <p>
        Search results:
        <span tal:replace="python:view.do_search().get('results')"></span>
      </p>

      <!-- SEARCH RESULTS -->
      <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <div class="search-item" ng-repeat="item in app.get_results()">
            <div class="item">
              {{item.id}}
              <a href="{{item.url}}" target="_blank">{{item.title}}</a>
              {{item.tags}}
            </div>
          </div>
        </div>
      </div>

      <!-- SEARCH CRITERIA -->
      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6"
             ng-repeat="tag in app.get_tags(1)">
          <a href class="{{tag.btn_class}} {{app.is_pressed(tag.title)}}"
             ng-click="app.toggle_tag(tag.title)">
            <img ng-src="./{{tag.id}}-icon.png" alt="{{tag.title}}">
            <br>
            <span class="text text-uppercase">{{tag.title}}</span>
          </a>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <!-- Insitu Tags -->
          <div class="insitu-btn-tags-container search-filters text-center">
            <div id="insitu-tags-1">
              <a href
                 ng-repeat="tag in app.get_tags(2)"
                 ng-click="app.toggle_tag(tag.title)"
                 class="{{tag.btn_class}} {{app.is_pressed(tag.title)}}">
                {{tag.title}}
              </a>
            </div>
            <div id="insitu-tags-2">
              <a href
                 ng-repeat="tag in app.get_tags(3)"
                 ng-click="app.toggle_tag(tag.title)"
                 class="{{tag.btn_class}} {{app.is_pressed(tag.title)}}">
                {{tag.title}}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
angular.module('searchApp', [])
  .controller('searchController', function() {
    var app = this;

    app.tags = [
      {
        category: 1,
        title: 'Observations',
        id: 'observation',  // the icon is without s
        btn_class: 'btn btn-default btn-block insitu-btn-observations'
      },
      {
        category: 1,
        title: 'Spatial Data',
        id: 'spatial-data',
        btn_class: 'btn btn-default btn-block insitu-btn-spatial-data'
      },
      {
        category: 2,
        title: 'Policy',
        id: 'policy',
        btn_class: 'btn btn-default insitu-btn-policy'
      },
      {
        category: 2,
        title: 'Agreements',
        id: 'agreements',
        btn_class: 'btn btn-default insitu-btn-agreements'
      },
      {
        category: 2,
        title: 'Infrastructure',
        id: 'infrastructure',
        btn_class: 'btn btn-default insitu-btn-infrastructure'
      },
      {
        category: 2,
        title: 'Open Data',
        id: 'open-data',
        btn_class: 'btn btn-default insitu-btn-open-data'
      },
      {
        category: 3,
        title: 'Land',
        id: 'land',
        btn_class: 'btn btn-default insitu-btn-land'
      },
      {
        category: 3,
        title: 'Marine',
        id: 'marine',
        btn_class: 'btn btn-default insitu-btn-marine'
      },
      {
        category: 3,
        title: 'Atmosphere',
        id: 'atmosphere',
        btn_class: 'btn btn-default insitu-btn-atmosphere'
      },
      {
        category: 3,
        title: 'Emergency',
        id: 'emergency',
        btn_class: 'btn btn-default insitu-btn-emergency'
      },
      {
        category: 3,
        title: 'Security',
        id: 'security',
        btn_class: 'btn btn-default insitu-btn-security'
      },
      {
        category: 3,
        title: 'Climate Change',
        id: 'climate-change',
        btn_class: 'btn btn-default insitu-btn-climate-change'
      }
    ]

    app.items = [
      {
        id: '01',
        title: 'Title here 1',
        url: 'http://www.google.com',
        tags: ['Security', 'Emergency', 'Observations']
      },
      {
        id: '02',
        title: 'Title here 2',
        url: 'http://www.google.com',
        tags: ['Spatial Data', 'Security']
      },
      {
        id: '03',
        title: 'Title here 3',
        url: 'http://www.google.com',
        tags: ['Climate Change']
      }
    ];

    app.selected_tags = ['Security'];

    app.superset_includes_subset = function arrayContainsArray (superset, subset) {
      // Return true if all values in subset exist in superset
      return subset.every(function (value) {
        return (superset.indexOf(value) >= 0);
      });
    }

    app.item_has_tags = function(item, tags) {
      // Return true if all tags are present in item's tags
      return app.superset_includes_subset(item.tags, tags);
    }

    app.get_results = function() {
      // Filter items by selected tags
      result = [];
      angular.forEach(app.items, function(an_item) {
        if(app.item_has_tags(an_item, app.selected_tags)) {
          result.push(an_item);
        }
      });
      return result;
    }

    app.get_tags = function(category) {
      // Return tags by given category
      result = [];
      angular.forEach(app.tags, function(a_tag) {
        if(a_tag.category == category) {
          result.push(a_tag);
        }
      });
      return result;
    }

    app.tag_is_selected = function(tag_name) {
      // Return true if the tag is selected as criteria for search
      var result = false;
      angular.forEach(app.selected_tags, function(a_tag_name) {
        if(a_tag_name == tag_name) {
          result = true;
        }
      });
      return result;
    }

    app.is_pressed = function(tag_name) {
      // Return 'pressed' or '' to be used as class name for btn
      if(app.tag_is_selected(tag_name)) {
        return 'pressed';
      }
      return '';
    }

    app.add_tag = function(tag_name) {
      // Add a given tag in the selected tags
      app.selected_tags.push(tag_name);
    }

    app.remove_tag = function(tag_name) {
      // Remove a given tag from the selected tags
      app.selected_tags.splice(app.selected_tags.indexOf(tag_name), 1);
    }

    app.toggle_tag = function(tag_name) {
      // Select or deselect a given tag from search criteria
      if(app.tag_is_selected(tag_name)) {
        app.remove_tag(tag_name);
      } else {
        app.add_tag(tag_name);
      }
      alert(app.selected_tags);
    }

  });
</script>



    </metal:main_macro>
  </metal:content-core>
</body>
</html>

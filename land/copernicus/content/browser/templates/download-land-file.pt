<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<body>

<metal:description fill-slot="content-description" />

<metal:content-core fill-slot="content-core">
<metal:main_macro define-macro="content-core">
  <p i18n:translate="">Download will start soon. Please wait.</p>
  <div tal:define="professional_thematic_domain python:view.values.get('professional_thematic_domain', '');
                   institutional_domain python:view.values.get('institutional_domain');
                   start_download_url python:view.values.get('start_download_url');
                   land_item_title python:context.title">

    <script tal:content="string:var land_item_title='${land_item_title}';"></script>
    <script tal:content="string:var professional_thematic_domain='${professional_thematic_domain}';"></script>
    <script tal:content="string:var institutional_domain='${institutional_domain}';"></script>
    <script tal:content="string:var start_download_url='${start_download_url}';"></script>

    <script>
      $(document).ready(function(){

        function get_browser_info(){
          /* Return browser name and version */
          var ua=navigator.userAgent,tem,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || []; 
          if(/trident/i.test(M[1])){
            tem=/\brv[ :]+(\d+)/g.exec(ua) || [];
            return {name:'IE',version:(tem[1]||'')};
          }

          if(M[1]==='Chrome'){
            tem=ua.match(/\bOPR\/(\d+)/)
            if(tem!=null)   {return {name:'Opera', version:tem[1]};}
          }

          M=M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];

          if((tem=ua.match(/version\/(\d+)/i))!=null) {
            M.splice(1,1,tem[1]);
          }

          return {
            name: M[0],
            version: M[1]
          };
        }

        // Custom dimensions
        ga('set', 'dimension1', professional_thematic_domain);
        ga('set', 'dimension2', institutional_domain);

        // Track event
        ga('send', {
          'hitType': 'event',                 // Required.
          'eventCategory': 'page',            // Required.
          'eventAction': 'landfile_download', // Required.
          'eventLabel': land_item_title,
          'eventValue': 1
        });

        var user_browser = get_browser_info().name;
        if(user_browser != "Safari") {
          // Start download the file and close the tab
          var newTab = window.open(start_download_url, "_blank");
          window.top.close();
        } else {
          // For Safari we use invisible iframe to download the file.
          // Auto close new tab not possible
          $("#download-iframe").attr("src", start_download_url);
        }
      });
    </script>
  </div>

  <!-- used for safari -->
  <iframe id="download-iframe" src="" frameborder="0" style="display:none"></iframe>
  <!-- used for safari -->

</metal:main_macro>
</metal:content-core>
</body>
</html>
